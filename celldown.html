<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard JABO - Cell Down</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root {
  --font-plus-jakarta: 'Plus Jakarta Sans', sans-serif;
  --font-inter: 'Inter', sans-serif;
  --primary-blue: #3b82f6;
  --success-green: #10b981;
  --warning-yellow: #f59e0b;
  --danger-red: #ef4444;
  --info-cyan: #06b6d4;
}

body {
  margin: 0;
  background: #f8fafc;
  font-family: var(--font-inter);
  min-height: 100vh;
  overflow-x: hidden;
}

/* HEADER */
.executive-header {
  background: linear-gradient(135deg, #1a2980, #26d0ce);
  color: white;
  padding: 16px 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.executive-header h1 {
  font-family: var(--font-plus-jakarta);
  font-weight: 700;
  font-size: 1.5rem !important;
  margin: 0;
}

.executive-header p {
  font-family: var(--font-inter);
  font-weight: 400;
  font-size: 14px;
  opacity: 0.9;
  margin: 0;
}

/* LAST UPDATE */
#currentTime, #lastUpdatedTime, #nextRefreshTime {
  font-family: var(--font-inter);
  font-weight: 500;
  font-size: 14px;
}

/* KPI CARDS */
.kpi-card {
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
  transition: all 0.3s ease;
  border: none;
  overflow: hidden;
  height: 100%;
  padding: 20px;
}

.kpi-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,.15);
}

.kpi-value {
  font-family: var(--font-plus-jakarta);
  font-weight: 800;
  font-size: 1.75rem;
  color: #1e293b;
}

.card-title {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 14px;
  color: #4b5563;
}

/* FILTER CARDS */
.filter-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  border: none;
  padding: 20px;
}

.filter-card .input-group-text {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 14px;
}

.filter-card .form-control {
  font-family: var(--font-inter);
  font-weight: 400;
  font-size: 14px;
  height: 46px;
}

/* BUTTONS */
.btn {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 14px;
  border-radius: 10px;
  padding: 10px 20px;
  border: none;
}

.btn-primary {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
}

.btn-outline-success {
  border: 1px solid var(--success-green);
  color: var(--success-green);
}

.btn-primary:hover, .btn-outline-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* SUMMARY CARDS */
.summary-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  padding: 24px;
  border: none;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.summary-card h6 {
  font-family: var(--font-plus-jakarta);
  font-weight: 700;
  color: #1e293b;
  margin-bottom: 16px;
  font-size: 16px;
}

/* TABLE STYLES */
.table thead th {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  background: linear-gradient(135deg, #1e293b, #334155);
  color: #fff;
  position: sticky;
  top: 0;
  z-index: 10;
  border: none;
  padding: 12px 10px;
}

.table tbody td {
  font-family: var(--font-inter);
  font-weight: 400;
  font-size: 12px;
  padding: 10px 8px;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
}

.table-striped tbody tr:nth-of-type(odd) {
  background-color: #f8fafc;
}

.table-hover tbody tr:hover {
  background-color: #f1f5f9;
}

/* BADGES */
.badge {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 11px;
  border: none;
}

/* MAIN TABLE CONTAINER */
.main-table-container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  border: none;
  overflow: hidden;
  flex: 1;
  display: flex;
  flex-direction: column;
  min-height: 500px;
}

.main-table-wrapper {
  overflow: auto;
  flex: 1;
  border-radius: 0 0 16px 16px;
}

/* SITE ID CELL */
.site-id-cell {
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  font-weight: 600;
  color: #1e40af;
  font-size: 11px;
}

/* LOADING */
.loading {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 60px;
  font-size: 16px;
  color: #64748b;
  font-family: var(--font-inter);
  flex: 1;
}

/* PROGRESS BARS */
.progress {
  height: 8px;
  border-radius: 4px;
  background-color: #e2e8f0;
  overflow: hidden;
}

.progress-bar {
  border-radius: 4px;
}

/* DASHBOARD STATUS BADGE */
#dashboardStatus {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
}

/* CARD HEADER */
.card-header {
  background: white;
  border-bottom: 1px solid #e2e8f0;
  padding: 20px 24px;
  border-radius: 16px 16px 0 0;
  flex-shrink: 0;
}

.card-header h6 {
  font-family: var(--font-plus-jakarta);
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}

/* EXPORT BUTTON */
.export-btn {
  background: linear-gradient(135deg, #10b981, #34d399);
  color: white;
}

.export-btn:hover {
  background: linear-gradient(135deg, #0da271, #2bbd88);
  color: white;
}

/* FORM SWITCH */
.form-check-label {
  font-family: var(--font-inter);
  font-weight: 500;
  font-size: 14px;
  color: #475569;
}

.form-check-input:checked {
  background-color: var(--primary-blue);
  border-color: var(--primary-blue);
}

/* SEARCH HIGHLIGHT */
.search-highlight {
  background-color: #fff3cd;
  padding: 2px 4px;
  border-radius: 3px;
  font-weight: 600;
}

/* COORDINATES INFO */
.coordinates-info {
  font-family: var(--font-inter);
  font-size: 11px;
  color: #64748b;
  margin-top: 2px;
}

/* AGING BADGES */
.aging-badge-1 {
  background: linear-gradient(135deg, #dbeafe, #93c5fd);
  color: #1e40af;
}

.aging-badge-3 {
  background: linear-gradient(135deg, #fef3c7, #fbbf24);
  color: #92400e;
}

.aging-badge-4 {
  background: linear-gradient(135deg, #fee2e2, #f87171);
  color: #991b1b;
}

/* RESPONSIVE ADJUSTMENTS */
@media (max-width: 768px) {
  .executive-header {
    padding: 12px 16px;
    text-align: center;
  }
  
  .executive-header h1 {
    font-size: 1.2rem !important;
  }
  
  .kpi-value {
    font-size: 1.5rem;
  }
  
  .main-table-container {
    min-height: 400px;
  }
  
  .main-container {
    padding: 16px;
  }
}

/* MAIN CONTAINER */
.main-container {
  flex: 1;
  padding: 24px;
  display: flex;
  flex-direction: column;
}

/* FOOTER */
.footer {
  flex-shrink: 0;
  padding: 20px 0;
  background: #f8fafc;
  border-top: 1px solid #e2e8f0;
}

.footer p {
  margin: 0;
  font-family: var(--font-inter);
  font-size: 13px;
  color: #64748b;
}

/* UTILITY CLASSES */
.cursor-pointer {
  cursor: pointer;
}

.text-truncate-cell {
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* SCROLLBAR STYLING */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* ALARM COUNT BREAKDOWN */
.alarm-count-container {
  flex: 1;
  overflow-y: auto;
  margin-top: 10px;
}

.alarm-count-table {
  width: 100%;
  border-collapse: collapse;
}

.alarm-count-table th {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 12px;
  text-align: left;
  padding: 8px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}

.alarm-count-table td {
  font-family: var(--font-inter);
  font-size: 12px;
  padding: 8px;
  border-bottom: 1px solid #f1f5f9;
}

/* SITE BREAKDOWN */
.site-breakdown-container {
  flex: 1;
  overflow-y: auto;
  margin-top: 10px;
}

.site-breakdown-table {
  width: 100%;
  border-collapse: collapse;
}

.site-breakdown-table th {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  font-size: 12px;
  text-align: left;
  padding: 8px;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
}

.site-breakdown-table td {
  font-family: var(--font-inter);
  font-size: 12px;
  padding: 8px;
  border-bottom: 1px solid #f1f5f9;
}

/* GRID LAYOUT */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 1200px) {
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
}

/* SUMMARY GRID */
.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

/* DATA INFO CARD */
.data-info-card {
  background: white;
  border-radius: 12px;
  padding: 15px;
  margin-bottom: 15px;
  border-left: 4px solid var(--primary-blue);
}

.data-info-card h6 {
  font-family: var(--font-plus-jakarta);
  font-weight: 600;
  margin: 0 0 8px 0;
  color: #1e293b;
  font-size: 14px;
}

.data-info-card p {
  font-family: var(--font-inter);
  font-size: 12px;
  color: #64748b;
  margin: 0;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="executive-header">
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="mb-2"><i class="fas fa-tower-cell me-2"></i>Dashboard JABO - Cell Down</h1>
        <p class="small opacity-75">Real-time Cell Down Monitoring & Analysis</p>
      </div>
      <div class="text-end">
        <div class="small mb-2"><i class="fas fa-clock me-1"></i> <span id="currentTime">Loading...</span></div>
        <span class="badge bg-warning" id="dashboardStatus">
          <i class="fas fa-circle me-1"></i> Loading Data...
        </span>
      </div>
    </div>
  </div>
</div>

<!-- MAIN CONTAINER -->
<div class="main-container">
  
  <!-- SEARCH AND FILTER ROW -->
  <div class="row mb-4">
    <div class="col-lg-8 col-md-7">
      <div class="filter-card">
        <h6 class="mb-3"><i class="fas fa-search me-2"></i>Search & Filter Alarms</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
              <input type="text" class="form-control" id="searchSiteId" placeholder="Site ID" onkeyup="applyFilters()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-building"></i></span>
              <input type="text" class="form-control" id="searchSiteName" placeholder="Site Name" onkeyup="applyFilters()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-satellite-dish"></i></span>
              <select class="form-control" id="filterSource" onchange="applyFilters()">
                <option value="">All Sources</option>
                <option value="MAE6">MAE6</option>
                <option value="MAE7">MAE7</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-8">
            <small class="text-muted" id="searchResultsText">Start typing to filter alarms</small>
          </div>
          <div class="col-md-4">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
              <i class="fas fa-eraser me-1"></i> Clear Filters
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-md-5">
      <div class="filter-card">
        <h6 class="mb-3"><i class="fas fa-sync-alt me-2"></i>Data Control</h6>
        <div class="d-flex flex-column gap-2">
          <button class="btn btn-primary w-100" onclick="fetchData()" id="btnRefresh">
            <i class="fas fa-redo me-1"></i> Refresh Data
          </button>
          <div class="d-flex align-items-center justify-content-between">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
              <label class="form-check-label" for="autoRefreshToggle">Auto-refresh (5min)</label>
            </div>
            <div class="small text-muted" id="dataInfo">No data loaded</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI SUMMARY ROW -->
  <div class="row mb-4">
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
      <div class="kpi-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">TOTAL ALARM COUNT</h6>
            <div class="kpi-value text-danger" id="kpiTotalAlarms">0</div>
          </div>
          <div class="align-self-center">
            <i class="fas fa-bell fa-2x text-danger opacity-50"></i>
          </div>
        </div>
        <div class="small text-muted mt-2">Sum of all alarm counts</div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
      <div class="kpi-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">UNIQUE SITES</h6>
            <div class="kpi-value text-warning" id="kpiAffectedSites">0</div>
          </div>
          <div class="align-self-center">
            <i class="fas fa-map-marker-alt fa-2x text-warning opacity-50"></i>
          </div>
        </div>
        <div class="small text-muted mt-2">Unique site IDs with alarms</div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
      <div class="kpi-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">AGING ≤ 1 DAY</h6>
            <div class="kpi-value text-info" id="kpiAging1">0</div>
          </div>
          <div class="align-self-center">
            <i class="fas fa-clock fa-2x text-info opacity-50"></i>
          </div>
        </div>
        <div class="small text-muted mt-2">New alarms (≤ 24 hours)</div>
      </div>
    </div>
    <div class="col-xl-3 col-lg-6 col-md-6 mb-3">
      <div class="kpi-card">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="card-title">SITES WITH LOCATION</h6>
            <div class="kpi-value text-success" id="kpiWithLocation">0</div>
          </div>
          <div class="align-self-center">
            <i class="fas fa-map fa-2x text-success opacity-50"></i>
          </div>
        </div>
        <div class="small text-muted mt-2">Sites with valid coordinates</div>
      </div>
    </div>
  </div>

  <!-- SUMMARY BREAKDOWN ROW -->
  <div class="dashboard-grid mb-4">
    <!-- ALARM TYPE BREAKDOWN -->
    <div class="summary-card">
      <h6><i class="fas fa-list-ol me-2 text-info"></i>Alarm Type Breakdown</h6>
      <div class="alarm-count-container">
        <table class="alarm-count-table">
          <thead>
            <tr>
              <th>Alarm Type</th>
              <th class="text-end">Count</th>
              <th class="text-end">%</th>
              <th>Distribution</th>
            </tr>
          </thead>
          <tbody id="alarmTypeBreakdown">
            <tr>
              <td colspan="4" class="text-center py-4 text-muted">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- SITE BREAKDOWN -->
    <div class="summary-card">
      <h6><i class="fas fa-building me-2 text-warning"></i>Top Affected Sites</h6>
      <div class="site-breakdown-container">
        <table class="site-breakdown-table">
          <thead>
            <tr>
              <th>Site ID</th>
              <th>Site Name</th>
              <th class="text-end">Alarm Count</th>
              <th class="text-end">Aging (Days)</th>
            </tr>
          </thead>
          <tbody id="siteBreakdown">
            <tr>
              <td colspan="4" class="text-center py-4 text-muted">Loading data...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- DATA INFO CARD -->
  <div class="data-info-card mb-4">
    <h6><i class="fas fa-info-circle me-2"></i>Data Information</h6>
    <p>
      <span id="dataStats">Loading data statistics...</span> | 
      Coordinates available for <span id="coordStats">0</span> sites |
      Last refresh: <span id="lastRefreshTime">-</span>
    </p>
  </div>

  <!-- MAIN DATA TABLE -->
  <div class="main-table-container">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0">
        <i class="fas fa-table me-2"></i>Detailed Cell Down Alarms
      </h6>
      <div>
        <span class="badge bg-info me-3" id="tableCountBadge">Showing 0 records</span>
        <button class="btn export-btn" onclick="exportToCSV()">
          <i class="fas fa-download me-1"></i> Export CSV
        </button>
      </div>
    </div>
    <div class="main-table-wrapper">
      <div id="loadingSpinner">
        <div class="text-center">
          <div class="spinner-border text-primary mb-3" role="status"></div>
          <p>Loading alarm data from Google Sheets...</p>
        </div>
      </div>
      <div class="table-responsive" id="dataTableContainer" style="display: none;">
        <table class="table table-striped table-hover table-bordered mb-0">
          <thead>
            <tr>
              <th class="cursor-pointer" onclick="sortTable('SITE ID')">Site ID <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('Alarm Source')">Site Name <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('Name')">Alarm Type <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer text-center" onclick="sortTable('Alarm Count')">Count <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('First Occurred (NT)')">First Occurred <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('Source')">Source <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('Updated At')">Updated At <i class="fas fa-sort ms-1"></i></th>
              <th class="cursor-pointer" onclick="sortTable('_agingDays')">Aging (Days) <i class="fas fa-sort ms-1"></i></th>
              <th class="text-center">Location</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <!-- Data will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- FOOTER -->
<div class="footer">
  <div class="container-fluid">
    <div class="text-center">
      <p class="mb-1">
        <i class="fas fa-database me-1"></i> Data Source: Google Sheets CSV | 
        <i class="fas fa-clock me-1 ms-3"></i> Last Updated: <span id="lastUpdatedTime">-</span> |
        <i class="fas fa-redo me-1 ms-3"></i> Next Auto-Refresh: <span id="nextRefreshTime">-</span>
      </p>
      <p class="mb-0">Dashboard refreshes automatically every 5 minutes. Click "Refresh Data" to update manually.</p>
    </div>
  </div>
</div>

<script>
// ==================== KONFIGURASI ====================
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReYyDGCMuGVv6quqOtRns55K-nHRF9Jc_9qmN9tNHACirvFr7YLPN3ZR3voorWD0opy7f1GflJ9eEC/pub?gid=219697226&single=true&output=csv";

// ==================== VARIABEL GLOBAL ====================
let allData = [];
let filteredData = [];
let currentSort = { column: 'First Occurred (NT)', direction: 'desc' };
let autoRefreshInterval = null;
let refreshCountdown = 300; // 5 minutes

// ==================== FUNGSI INISIALISASI ====================
document.addEventListener('DOMContentLoaded', function() {
  console.log('Dashboard JABO - Cell Down initializing...');
  updateCurrentTime();
  setInterval(updateCurrentTime, 1000);
  
  document.getElementById('autoRefreshToggle').addEventListener('change', toggleAutoRefresh);
  
  fetchData();
  
  // Setup auto-refresh
  setTimeout(() => {
    if (document.getElementById('autoRefreshToggle').checked) {
      startAutoRefresh();
    }
  }, 1000);
});

// ==================== FUNGSI DATA ====================
function fetchData() {
  console.log('Fetching data from:', CSV_URL);
  showLoading(true);
  updateDashboardStatus('loading', 'Fetching data...');
  
  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      console.log('CSV parsing complete. Rows:', results.data.length);
      
      if (results.data && results.data.length > 0) {
        processData(results.data);
        updateDashboardStatus('success', 'Data loaded successfully');
      } else {
        console.warn('No data found in CSV');
        showError('No data found in the CSV file.');
        updateDashboardStatus('error', 'No data found');
      }
      showLoading(false);
      updateLastUpdatedTime();
      resetAutoRefreshCountdown();
    },
    error: function(error) {
      console.error('Error fetching CSV:', error);
      showError('Failed to load data from CSV. Please check the URL.');
      updateDashboardStatus('error', 'Failed to load data');
      showLoading(false);
    }
  });
}

function processData(rawData) {
  allData = [];
  let totalAlarmCount = 0;
  let sitesWithLocation = 0;
  
  rawData.forEach(row => {
    if (!row['Name'] || !row['SITE ID']) return;
    
    // Calculate aging
    const firstOccurred = row['First Occurred (NT)'];
    let agingDays = 0;
    
    if (firstOccurred && firstOccurred !== '-') {
      try {
        const firstDate = new Date(firstOccurred);
        const now = new Date();
        agingDays = (now - firstDate) / (1000 * 3600 * 24);
        agingDays = Math.max(0, agingDays);
      } catch (e) {
        console.warn('Error parsing date:', firstOccurred);
      }
    }
    
    // Add aging category
    let agingCategory = "";
    if (agingDays <= 1) agingCategory = "≤1 Day";
    else if (agingDays <= 3) agingCategory = "≤3 Days";
    else agingCategory = "≥4 Days";
    
    // Parse coordinates
    let lat = null;
    let lng = null;
    
    const latValue = row["Lat"];
    const lngValue = row["Long"];
    
    if (latValue && lngValue && latValue !== '' && lngValue !== '') {
      try {
        lat = parseFloat(latValue.toString().replace(',', '.'));
        lng = parseFloat(lngValue.toString().replace(',', '.'));
        
        if (!isNaN(lat) && !isNaN(lng) && 
            lat >= -90 && lat <= 90 && 
            lng >= -180 && lng <= 180) {
          sitesWithLocation++;
        } else {
          lat = null;
          lng = null;
        }
      } catch (e) {
        console.warn('Error parsing coordinates:', e);
        lat = null;
        lng = null;
      }
    }
    
    // Add to total alarm count
    const alarmCount = parseInt(row["Alarm Count"]) || 0;
    totalAlarmCount += alarmCount;
    
    const processedRow = {
      ...row,
      _agingDays: agingDays,
      _agingCategory: agingCategory,
      _agingBadgeClass: getAgingBadgeClass(agingDays),
      _lat: lat,
      _lng: lng,
      _hasLocation: lat !== null && lng !== null,
      _alarmCountNum: alarmCount
    };
    
    allData.push(processedRow);
  });
  
  console.log(`Processed ${allData.length} records`);
  console.log(`Total alarm count: ${totalAlarmCount}`);
  console.log(`Sites with location: ${sitesWithLocation}`);
  
  applyFilters();
}

function getAgingBadgeClass(days) {
  if (days <= 1) return 'aging-badge-1';
  if (days <= 3) return 'aging-badge-3';
  return 'aging-badge-4';
}

// ==================== FUNGSI FILTER & PENCARIAN ====================
function applyFilters() {
  const siteId = document.getElementById('searchSiteId').value.toLowerCase().trim();
  const siteName = document.getElementById('searchSiteName').value.toLowerCase().trim();
  const source = document.getElementById('filterSource').value;
  
  console.log(`Applying filters - Site ID: "${siteId}", Site Name: "${siteName}", Source: "${source}"`);
  
  filteredData = allData.filter(item => {
    const siteIdMatch = !siteId || 
      (item['SITE ID'] && item['SITE ID'].toLowerCase().includes(siteId));
    
    const siteNameMatch = !siteName || 
      (item['Alarm Source'] && item['Alarm Source'].toLowerCase().includes(siteName));
    
    const sourceMatch = !source || 
      (item['Source'] && item['Source'] === source);
    
    return siteIdMatch && siteNameMatch && sourceMatch;
  });
  
  const resultsText = document.getElementById('searchResultsText');
  if (siteId || siteName || source) {
    const sitesWithLocation = filteredData.filter(item => item._hasLocation).length;
    resultsText.textContent = `Found ${filteredData.length} records (${sitesWithLocation} with location)`;
    resultsText.className = 'text-success fw-semibold';
  } else {
    resultsText.textContent = 'Start typing to filter alarms';
    resultsText.className = 'text-muted';
  }
  
  updateSummaryKPIs();
  updateAlarmTypeBreakdown();
  updateSiteBreakdown();
  updateDataTable();
  updateDataStats();
}

function clearFilters() {
  document.getElementById('searchSiteId').value = '';
  document.getElementById('searchSiteName').value = '';
  document.getElementById('filterSource').value = '';
  document.getElementById('searchResultsText').textContent = 'Start typing to filter alarms';
  document.getElementById('searchResultsText').className = 'text-muted';
  applyFilters();
}

// ==================== FUNGSI UPDATE UI ====================
function updateSummaryKPIs() {
  const totalAlarmCount = filteredData.reduce((sum, item) => {
    return sum + (parseInt(item["Alarm Count"]) || 0);
  }, 0);
  
  const uniqueSites = new Set(filteredData.map(item => item['SITE ID']).filter(Boolean)).size;
  
  let aging1 = 0, aging3 = 0, aging4 = 0;
  filteredData.forEach(item => {
    if (item._agingDays <= 1) aging1++;
    else if (item._agingDays <= 3) aging3++;
    else aging4++;
  });
  
  const sitesWithLocation = filteredData.filter(item => item._hasLocation).length;
  
  document.getElementById('kpiTotalAlarms').textContent = totalAlarmCount.toLocaleString();
  document.getElementById('kpiAffectedSites').textContent = uniqueSites.toLocaleString();
  document.getElementById('kpiAging1').textContent = aging1.toLocaleString();
  document.getElementById('kpiWithLocation').textContent = sitesWithLocation.toLocaleString();
}

function updateAlarmTypeBreakdown() {
  const tbody = document.getElementById('alarmTypeBreakdown');
  
  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4 text-muted">No data available</td>
      </tr>
    `;
    return;
  }
  
  // Group by alarm type
  const alarmTypeCounts = {};
  filteredData.forEach(item => {
    const alarmType = item['Name'] || 'Unknown';
    if (!alarmTypeCounts[alarmType]) {
      alarmTypeCounts[alarmType] = {
        count: 0,
        totalCount: 0
      };
    }
    alarmTypeCounts[alarmType].count++;
    alarmTypeCounts[alarmType].totalCount += item._alarmCountNum || 0;
  });
  
  // Convert to array and sort
  const alarmTypes = Object.entries(alarmTypeCounts)
    .map(([type, data]) => ({
      type,
      count: data.count,
      totalCount: data.totalCount
    }))
    .sort((a, b) => b.totalCount - a.totalCount)
    .slice(0, 15); // Show top 15
  
  const totalRecords = filteredData.length;
  
  tbody.innerHTML = '';
  
  alarmTypes.forEach(alarm => {
    const percentage = ((alarm.count / totalRecords) * 100).toFixed(1);
    const percentageBar = Math.min(percentage, 100);
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="text-truncate-cell" title="${alarm.type}">${alarm.type}</td>
      <td class="text-end fw-semibold">${alarm.totalCount.toLocaleString()}</td>
      <td class="text-end">${percentage}%</td>
      <td>
        <div class="progress" style="height: 6px;">
          <div class="progress-bar bg-info" style="width: ${percentageBar}%"></div>
        </div>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function updateSiteBreakdown() {
  const tbody = document.getElementById('siteBreakdown');
  
  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="text-center py-4 text-muted">No data available</td>
      </tr>
    `;
    return;
  }
  
  // Group by site
  const siteData = {};
  filteredData.forEach(item => {
    const siteId = item['SITE ID'] || 'Unknown';
    if (!siteData[siteId]) {
      siteData[siteId] = {
        siteId,
        siteName: item['Alarm Source'] || 'Unknown',
        totalCount: 0,
        maxAging: 0
      };
    }
    siteData[siteId].totalCount += item._alarmCountNum || 0;
    siteData[siteId].maxAging = Math.max(siteData[siteId].maxAging, item._agingDays || 0);
  });
  
  // Convert to array and sort
  const sites = Object.values(siteData)
    .sort((a, b) => b.totalCount - a.totalCount)
    .slice(0, 15); // Show top 15
  
  tbody.innerHTML = '';
  
  sites.forEach(site => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="site-id-cell">${site.siteId}</td>
      <td class="text-truncate-cell" title="${site.siteName}">${site.siteName}</td>
      <td class="text-end fw-semibold">${site.totalCount.toLocaleString()}</td>
      <td class="text-end">
        <span class="badge ${getAgingBadgeClass(site.maxAging)}">
          ${Math.round(site.maxAging)}d
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function updateDataStats() {
  const sitesWithLocation = filteredData.filter(item => item._hasLocation).length;
  const percentageWithLocation = filteredData.length > 0 
    ? ((sitesWithLocation / filteredData.length) * 100).toFixed(1)
    : 0;
  
  document.getElementById('dataStats').textContent = 
    `${filteredData.length.toLocaleString()} records, ${new Set(filteredData.map(d => d['SITE ID'])).size.toLocaleString()} unique sites`;
  
  document.getElementById('coordStats').textContent = 
    `${sitesWithLocation.toLocaleString()} (${percentageWithLocation}%)`;
  
  document.getElementById('lastRefreshTime').textContent = 
    new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
}

function updateDataTable() {
  const tbody = document.getElementById('dataTableBody');
  const container = document.getElementById('dataTableContainer');
  const countBadge = document.getElementById('tableCountBadge');
  
  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-5">
          <i class="fas fa-search fa-2x text-muted mb-3"></i><br>
          No alarms found matching your criteria
        </td>
      </tr>
    `;
    countBadge.textContent = 'Showing 0 records';
    container.style.display = 'block';
    return;
  }
  
  let sortedData = [...filteredData];
  
  sortedData.sort((a, b) => {
    const aVal = a[currentSort.column];
    const bVal = b[currentSort.column];
    
    // Handle date columns
    if (currentSort.column.includes('Occurred') || currentSort.column.includes('Updated')) {
      const aDate = aVal ? new Date(aVal).getTime() : 0;
      const bDate = bVal ? new Date(bVal).getTime() : 0;
      return currentSort.direction === 'asc' ? aDate - bDate : bDate - aDate;
    }
    
    // Handle numeric columns
    if (currentSort.column === 'Alarm Count' || currentSort.column === '_alarmCountNum') {
      const aNum = currentSort.column === 'Alarm Count' ? parseInt(aVal) || 0 : aVal || 0;
      const bNum = currentSort.column === 'Alarm Count' ? parseInt(bVal) || 0 : bVal || 0;
      return currentSort.direction === 'asc' ? aNum - bNum : bNum - aNum;
    }
    
    // Handle aging days
    if (currentSort.column === '_agingDays') {
      return currentSort.direction === 'asc' ? a._agingDays - b._agingDays : b._agingDays - a._agingDays;
    }
    
    // Handle string columns
    if (typeof aVal === 'string' && typeof bVal === 'string') {
      return currentSort.direction === 'asc' 
        ? aVal.localeCompare(bVal)
        : bVal.localeCompare(aVal);
    }
    
    return 0;
  });
  
  tbody.innerHTML = '';
  
  sortedData.forEach(item => {
    const siteId = item['SITE ID'] || '';
    const alarmSource = item['Alarm Source'] || '';
    const alarmName = item['Name'] || 'CELL UNAVAILABLE';
    const alarmCount = item['Alarm Count'] || '0';
    const firstOccurred = formatDateTime(item['First Occurred (NT)']);
    const source = item['Source'] || '';
    const updatedAt = formatDateTime(item['Updated At']);
    const agingDays = Math.round(item._agingDays);
    
    const locationCell = item._hasLocation 
      ? `<span class="badge bg-success"><i class="fas fa-map-marker-alt"></i> ${item._lat.toFixed(4)}, ${item._lng.toFixed(4)}</span>`
      : `<span class="badge bg-secondary"><i class="fas fa-map-marker-alt-slash"></i> No location</span>`;
    
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="site-id-cell">${siteId}</td>
      <td>${alarmSource}</td>
      <td><span class="badge bg-primary">${alarmName}</span></td>
      <td class="text-center"><span class="badge bg-info">${alarmCount}</span></td>
      <td class="small">${firstOccurred}</td>
      <td><span class="badge bg-dark">${source}</span></td>
      <td class="small">${updatedAt}</td>
      <td>
        <span class="badge ${item._agingBadgeClass}">
          ${item._agingCategory} (${agingDays}d)
        </span>
      </td>
      <td class="text-center">${locationCell}</td>
    `;
    tbody.appendChild(row);
  });
  
  countBadge.textContent = `Showing ${filteredData.length.toLocaleString()} records`;
  container.style.display = 'block';
}

function formatDateTime(datetimeStr) {
  if (!datetimeStr || datetimeStr === '-') return '-';
  try {
    const date = new Date(datetimeStr);
    if (isNaN(date.getTime())) return datetimeStr;
    return date.toLocaleString('en-GB', { 
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    }).replace(',', '');
  } catch (e) {
    return datetimeStr;
  }
}

// ==================== FUNGSI SORT ====================
function sortTable(column) {
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = 'desc';
  }
  
  updateDataTable();
  
  // Update sort icons
  document.querySelectorAll('thead th i').forEach(icon => {
    icon.className = 'fas fa-sort ms-1';
  });
  
  // Highlight current sort column
  const headerCells = document.querySelectorAll('thead th');
  headerCells.forEach((cell, index) => {
    if (cell.textContent.includes(column) || cell.getAttribute('onclick')?.includes(column)) {
      const icon = cell.querySelector('i');
      if (icon) {
        icon.className = currentSort.direction === 'asc' 
          ? 'fas fa-sort-up ms-1' 
          : 'fas fa-sort-down ms-1';
      }
    }
  });
}

// ==================== FUNGSI EXPORT ====================
function exportToCSV() {
  if (filteredData.length === 0) {
    alert('No data to export!');
    return;
  }
  
  const headers = [
    'SITE ID', 'Alarm Source', 'Name', 'Alarm Count', 
    'First Occurred (NT)', 'Source', 'Updated At', 'Lat', 'Long'
  ];
  
  const csvData = [
    headers.join(','),
    ...filteredData.map(row => [
      row['SITE ID'] || '',
      `"${(row['Alarm Source'] || '').replace(/"/g, '""')}"`,
      `"${(row['Name'] || '').replace(/"/g, '""')}"`,
      row['Alarm Count'] || '0',
      row['First Occurred (NT)'] || '',
      row['Source'] || '',
      row['Updated At'] || '',
      row['Lat'] || '',
      row['Long'] || ''
    ].join(','))
  ].join('\n');
  
  const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `cell_down_${new Date().toISOString().slice(0,10)}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  alert(`Exported ${filteredData.length} records to CSV`);
}

// ==================== FUNGSI WAKTU & STATUS ====================
function updateCurrentTime() {
  const now = new Date();
  const options = { 
    weekday: 'short', 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric',
    hour: '2-digit', 
    minute: '2-digit', 
    second: '2-digit',
    hour12: false
  };
  document.getElementById('currentTime').textContent = 
    now.toLocaleDateString('en-GB', options).replace(',', '');
}

function updateLastUpdatedTime() {
  const now = new Date();
  const timeString = now.toLocaleTimeString('en-GB', { 
    hour: '2-digit', 
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  });
  document.getElementById('lastUpdatedTime').textContent = timeString;
  document.getElementById('dataInfo').textContent = `${filteredData.length} records loaded`;
}

function updateDashboardStatus(status, message) {
  const badge = document.getElementById('dashboardStatus');
  
  switch(status) {
    case 'loading':
      badge.className = 'badge bg-warning';
      badge.innerHTML = '<i class="fas fa-sync fa-spin me-1"></i> ' + message;
      break;
    case 'success':
      badge.className = 'badge bg-success';
      badge.innerHTML = '<i class="fas fa-check-circle me-1"></i> ' + message;
      break;
    case 'error':
      badge.className = 'badge bg-danger';
      badge.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i> ' + message;
      break;
  }
}

function showLoading(show) {
  const loadingDiv = document.getElementById('loadingSpinner');
  loadingDiv.style.display = show ? 'flex' : 'none';
  if (!show) {
    document.getElementById('dataTableContainer').style.display = 'block';
  }
}

function showError(message) {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = `
    <tr>
      <td colspan="9" class="text-center py-5 text-danger">
        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i><br>
        ${message}
      </td>
    </tr>
  `;
  document.getElementById('dataTableContainer').style.display = 'block';
}

// ==================== FUNGSI AUTO-REFRESH ====================
function toggleAutoRefresh() {
  const toggle = document.getElementById('autoRefreshToggle');
  
  if (toggle.checked) {
    startAutoRefresh();
  } else {
    stopAutoRefresh();
  }
}

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  
  refreshCountdown = 300;
  updateNextRefreshTime();
  
  autoRefreshInterval = setInterval(() => {
    refreshCountdown--;
    updateNextRefreshTime();
    
    if (refreshCountdown <= 0) {
      fetchData();
      refreshCountdown = 300;
    }
  }, 1000);
}

function stopAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
  document.getElementById('nextRefreshTime').textContent = 'Disabled';
}

function resetAutoRefreshCountdown() {
  const toggle = document.getElementById('autoRefreshToggle');
  if (toggle.checked) {
    refreshCountdown = 300;
    updateNextRefreshTime();
  }
}

function updateNextRefreshTime() {
  const minutes = Math.floor(refreshCountdown / 60);
  const seconds = refreshCountdown % 60;
  const nextRefreshEl = document.getElementById('nextRefreshTime');
  nextRefreshEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}
</script>

</body>
</html>
