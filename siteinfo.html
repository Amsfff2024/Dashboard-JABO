<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Information Dashboard</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <!-- PapaParse untuk parsing CSV -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        :root {
            --huawei-red: #ff0000;
            --nokia-blue: #124191;
            --ericsson-blue: #00205b;
            --zte-green: #0b9e00;
            --dark-blue: #2c3e50;
            --vip-gold: #ffc107;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        .executive-header {
            background: linear-gradient(135deg, var(--dark-blue), #1a252f);
            color: white;
            padding: 1rem 0;
            border-bottom: 4px solid var(--huawei-red);
        }
        .kpi-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.2s;
            height: 100%;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .card-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .vip-row {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 1.25rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            height: 100%;
        }
        #loadingSpinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 300px;
        }
        .cursor-pointer {
            cursor: pointer;
        }
        .search-highlight {
            background-color: #fff3cd;
            font-weight: 600;
        }
        .site-breakdown {
            max-height: 350px;
            overflow-y: auto;
        }
        .badge-huawei { background-color: var(--huawei-red); color: white; }
        .badge-nokia { background-color: var(--nokia-blue); color: white; }
        .badge-ericsson { background-color: var(--ericsson-blue); color: white; }
        .badge-zte { background-color: var(--zte-green); color: white; }
        .badge-2g { background-color: #6c757d; color: white; }
        .badge-4g { background-color: #28a745; color: white; }
        .badge-5g { background-color: #007bff; color: white; }
        .badge-vip { background-color: var(--vip-gold); color: #212529; }
        .badge-macro { background-color: #6610f2; color: white; }
        .badge-micro { background-color: #20c997; color: white; }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            z-index: 1;
        }
        .map-container {
            position: relative;
        }
        .leaflet-control-layers, .leaflet-control-zoom {
            border-radius: 5px !important;
            overflow: hidden;
        }
        .vendor-filter {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        .table thead th {
            background-color: var(--dark-blue);
            color: white;
            font-weight: 600;
            border: none;
        }
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 5px;
            border: 1px solid #ced4da;
            padding: 5px 10px;
        }
        .cluster-marker {
            background-color: #007bff;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .marker-huawei { background-color: var(--huawei-red); }
        .marker-nokia { background-color: var(--nokia-blue); }
        .marker-ericsson { background-color: var(--ericsson-blue); }
        .marker-zte { background-color: var(--zte-green); }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="executive-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h4 mb-1"><i class="fas fa-tower-cell me-2"></i>Site Information Dashboard</h1>
                    <p class="small mb-0 opacity-75">Network Site Data Visualization & Management</p>
                </div>
                <div class="text-end">
                    <div class="small mb-1"><i class="fas fa-clock me-1"></i> <span id="currentTime">Loading...</span></div>
                    <span class="badge bg-success" id="dashboardStatus">
                        <i class="fas fa-circle me-1"></i> Ready
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container py-4">
        <!-- Data Control Row -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card kpi-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="card-title mb-0"><i class="fas fa-database me-2"></i>Data Source Control</h6>
                                <small class="text-muted" id="dataSourceInfo">Loading data source information...</small>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="d-flex justify-content-end gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="fetchCSVData()" id="btnRefresh">
                                        <i class="fas fa-redo me-1"></i> Refresh Data
                                    </button>
                                    <div class="form-check form-switch d-flex align-items-center">
                                        <input class="form-check-input me-2" type="checkbox" id="autoRefreshToggle" checked>
                                        <label class="form-check-label small" for="autoRefreshToggle">Auto (30s)</label>
                                    </div>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="showSampleData()">
                                        <i class="fas fa-eye me-1"></i> Sample
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card kpi-card">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="fas fa-search me-2"></i>Search & Filter Sites</h6>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-id-badge"></i></span>
                                    <input type="text" class="form-control" id="searchSiteId" placeholder="Search by Site ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text"><i class="fas fa-tower-cell"></i></span>
                                    <input type="text" class="form-control" id="searchSiteName" placeholder="Search by Site Name">
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="filterVendor">
                                    <option value="">All Vendors</option>
                                    <option value="Huawei">Huawei</option>
                                    <option value="Nokia">Nokia</option>
                                    <option value="Ericsson">Ericsson</option>
                                    <option value="ZTE">ZTE</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="filterNetworkType">
                                    <option value="">All Network Types</option>
                                    <option value="2G">2G</option>
                                    <option value="4G">4G</option>
                                    <option value="5G">5G</option>
                                    <option value="2G_4G">2G_4G</option>
                                    <option value="2G_4G_5G">2G_4G_5G</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select form-select-sm" id="filterRegion">
                                    <option value="">All Regions</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card kpi-card">
                    <div class="card-body">
                        <h6 class="card-title mb-3"><i class="fas fa-filter me-2"></i>Quick Filters</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-danger" data-vendor="Huawei">
                                <i class="fas fa-server me-1"></i> Huawei
                            </button>
                            <button class="btn btn-sm btn-outline-primary" data-network="5G">
                                <i class="fas fa-bolt me-1"></i> 5G Sites
                            </button>
                            <button class="btn btn-sm btn-outline-warning" data-vip="true">
                                <i class="fas fa-crown me-1"></i> VIP Sites
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="clearFilters()">
                                <i class="fas fa-eraser me-1"></i> Clear All
                            </button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" id="searchResultsText">Loading data...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPI Summary Row -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card kpi-card border-start border-danger border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">TOTAL SITES</h6>
                                <div class="kpi-value text-danger" id="kpiTotalSites">0</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tower-cell fa-2x text-danger opacity-50"></i>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">All network sites</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card kpi-card border-start border-primary border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">5G SITES</h6>
                                <div class="kpi-value text-primary" id="kpi5GSites">0</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-bolt fa-2x text-primary opacity-50"></i>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">Sites with 5G capability</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card kpi-card border-start border-warning border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">VIP SITES</h6>
                                <div class="kpi-value text-warning" id="kpiVipSites">0</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-crown fa-2x text-warning opacity-50"></i>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">VIP & POI category sites</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card kpi-card border-start border-info border-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">MICRO CLUSTERS</h6>
                                <div class="kpi-value text-info" id="kpiClusters">0</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-sitemap fa-2x text-info opacity-50"></i>
                            </div>
                        </div>
                        <div class="small text-muted mt-2">Unique micro clusters</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Summary Row -->
        <div class="row mb-4">
            <!-- Map -->
            <div class="col-lg-8 mb-4">
                <div class="summary-card map-container">
                    <h6 class="mb-3"><i class="fas fa-map me-2 text-primary"></i>Site Locations</h6>
                    <div id="map"></div>
                    <div class="vendor-filter">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showHuawei" checked>
                            <label class="form-check-label" for="showHuawei">Huawei</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showNokia" checked>
                            <label class="form-check-label" for="showNokia">Nokia</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showEricsson" checked>
                            <label class="form-check-label" for="showEricsson">Ericsson</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showZTE" checked>
                            <label class="form-check-label" for="showZTE">ZTE</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Site Breakdown Summary -->
            <div class="col-lg-4 mb-4">
                <div class="summary-card">
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2 text-info"></i>Site Distribution</h6>
                    <div class="site-breakdown">
                        <table class="table table-sm table-borderless mb-0">
                            <thead>
                                <tr>
                                    <th class="small">Vendor</th>
                                    <th class="small text-end">Sites</th>
                                    <th class="small" style="width: 100px;">%</th>
                                </tr>
                            </thead>
                            <tbody id="vendorBreakdownBody">
                                <tr><td colspan="3" class="text-center py-4">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <hr>
                    <h6 class="mb-3 mt-3"><i class="fas fa-network-wired me-2 text-success"></i>Network Type</h6>
                    <div class="site-breakdown">
                        <table class="table table-sm table-borderless mb-0">
                            <thead>
                                <tr>
                                    <th class="small">Type</th>
                                    <th class="small text-end">Sites</th>
                                    <th class="small" style="width: 100px;">%</th>
                                </tr>
                            </thead>
                            <tbody id="networkBreakdownBody">
                                <tr><td colspan="3" class="text-center py-4">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Site Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                        <h6 class="mb-0"><i class="fas fa-table me-2"></i>Detailed Site Information</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-success" onclick="exportToCSV()">
                                <i class="fas fa-download me-1"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="detailedSiteTable">
                                <thead>
                                    <tr>
                                        <th>Site ID</th>
                                        <th>Site Name</th>
                                        <th>Vendor</th>
                                        <th>Network Type</th>
                                        <th>Site Type</th>
                                        <th>Category VIP POI</th>
                                        <th>Region</th>
                                        <th>Micro Cluster</th>
                                        <th>Enodeb ID</th>
                                        <th>TAC</th>
                                    </tr>
                                </thead>
                                <tbody id="detailedSiteTableBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="text-center small text-muted">
                    <p class="mb-1">
                        <i class="fas fa-database me-1"></i> Site Information Dashboard | 
                        <i class="fas fa-clock me-1 ms-3"></i> Last Updated: <span id="lastUpdatedTime">-</span>
                    </p>
                    <p class="mb-0">Click on map markers to view site details. Use filters to customize the view.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading site data from CSV...</p>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // ==================== KONFIGURASI ====================
        // URL CSV dari Google Sheets Anda
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReYyDGCMuGVv6quqOtRns55K-nHRF9Jc_9qmN9tNHACirvFr7YLPN3ZR3voorWD0opy7f1GflJ9eEC/pub?gid=1983955719&single=true&output=csv";
        
        // Data sample untuk fallback
        const SAMPLE_DATA = [
            {
                "Site ID": "11TGR0158",
                "Site Name": "VIP_GEDUNG_OPERASI_EP",
                "Vendor": "Huawei",
                "Network Type": "2G_4G_5G (GL_NR)",
                "Site Type": "VIP_Macro",
                "Category VIP POI": "Airport Route_Airport Route",
                "X_LONGITUDE": 106.644,
                "Y_LATITUDE": -6.13164,
                "NMS": "100.91.254.5",
                "Circle": "JAYA",
                "Region": "OUTER JAKARTA",
                "Micro Cluster": "MC-KARAWACI",
                "Enodeb ID": "310036",
                "TAC": "30172"
            },
            {
                "Site ID": "11TGR0284",
                "Site Name": "VIP_HOTEL_ORCHARD_CENGKARENG_CM",
                "Vendor": "Huawei",
                "Network Type": "2G_4G_5G (GL_NR)",
                "Site Type": "VIP_Macro",
                "Category VIP POI": "Airport Route_Airport Route",
                "X_LONGITUDE": 106.6848,
                "Y_LATITUDE": -6.11473,
                "NMS": "100.91.254.5",
                "Circle": "JAYA",
                "Region": "OUTER JAKARTA",
                "Micro Cluster": "MC-KARAWACI",
                "Enodeb ID": "310142",
                "TAC": "30172"
            },
            {
                "Site ID": "11TGR0304",
                "Site Name": "VIP_RAWABOKOR_TB",
                "Vendor": "Huawei",
                "Network Type": "2G_4G_5G (GL_NR)",
                "Site Type": "VIP_Macro",
                "Category VIP POI": "Airport Route_Airport Route",
                "X_LONGITUDE": 106.6902,
                "Y_LATITUDE": -6.11349,
                "NMS": "100.91.254.5",
                "Circle": "JAYA",
                "Region": "OUTER JAKARTA",
                "Micro Cluster": "MC-KARAWACI",
                "Enodeb ID": "311284",
                "TAC": "30172"
            }
        ];

        // ==================== VARIABEL GLOBAL ====================
        let allSiteData = [];
        let filteredSiteData = [];
        let map;
        let markers = [];
        let dataTable;
        let vendorStats = {};
        let networkStats = {};
        let autoRefreshInterval = null;
        let refreshCountdown = 30;

        // ==================== FUNGSI INISIALISASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Site Info Dashboard initializing...');
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // Setup auto-refresh toggle
            document.getElementById('autoRefreshToggle').addEventListener('change', toggleAutoRefresh);
            
            // Initialize DataTables
            initializeDataTable();
            
            // Initialize map
            initializeMap();
            
            // Fetch data from CSV
            fetchCSVData();
            
            // Setup event listeners
            setupEventListeners();
        });

        function initializeDataTable() {
            dataTable = $('#detailedSiteTable').DataTable({
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
                order: [[0, 'asc']],
                language: {
                    search: "Filter sites:"
                }
            });
        }

        function initializeMap() {
            // Initialize map centered on Jakarta area
            map = L.map('map').setView([-6.12, 106.67], 12);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        function setupEventListeners() {
            // Search inputs
            document.getElementById('searchSiteId').addEventListener('input', applyFilters);
            document.getElementById('searchSiteName').addEventListener('input', applyFilters);
            
            // Filter selects
            document.getElementById('filterVendor').addEventListener('change', applyFilters);
            document.getElementById('filterNetworkType').addEventListener('change', applyFilters);
            document.getElementById('filterRegion').addEventListener('change', applyFilters);
            
            // Quick filter buttons
            document.querySelectorAll('[data-vendor]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('filterVendor').value = this.getAttribute('data-vendor');
                    applyFilters();
                });
            });
            
            document.querySelectorAll('[data-network]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('filterNetworkType').value = this.getAttribute('data-network');
                    applyFilters();
                });
            });
            
            document.querySelectorAll('[data-vip]').forEach(btn => {
                btn.addEventListener('click', function() {
                    filterByVIP();
                });
            });
            
            // Map vendor filters
            document.getElementById('showHuawei').addEventListener('change', updateMapMarkers);
            document.getElementById('showNokia').addEventListener('change', updateMapMarkers);
            document.getElementById('showEricsson').addEventListener('change', updateMapMarkers);
            document.getElementById('showZTE').addEventListener('change', updateMapMarkers);
        }

        // ==================== FUNGSI DATA CSV ====================
        function fetchCSVData() {
            console.log('Fetching CSV data from:', CSV_URL);
            showLoading(true);
            updateDashboardStatus('loading', 'Fetching data...');
            
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log('CSV parsing complete. Rows:', results.data.length);
                    
                    if (results.data && results.data.length > 0) {
                        processSiteData(results.data);
                        updateDashboardStatus('success', 'Data loaded successfully');
                        updateDataSourceInfo(`Loaded ${results.data.length} sites from CSV`);
                    } else {
                        console.warn('No data found in CSV, using sample data');
                        processSiteData(SAMPLE_DATA);
                        updateDashboardStatus('warning', 'Using sample data');
                        updateDataSourceInfo('Using sample data - CSV was empty');
                    }
                    showLoading(false);
                    updateLastUpdatedTime();
                    resetAutoRefreshCountdown();
                },
                error: function(error) {
                    console.error('Error fetching CSV:', error);
                    console.log('Using sample data instead');
                    processSiteData(SAMPLE_DATA);
                    updateDashboardStatus('warning', 'Using sample data');
                    updateDataSourceInfo('Using sample data - CSV load failed');
                    showLoading(false);
                    updateLastUpdatedTime();
                }
            });
        }

        function processSiteData(rawData) {
            allSiteData = [];
            vendorStats = {};
            networkStats = {};
            
            // Get all unique regions for filter dropdown
            const regions = new Set();
            
            rawData.forEach(site => {
                // Clean and validate data
                const cleanedSite = {};
                
                // Process each column
                Object.keys(site).forEach(key => {
                    const value = site[key] ? site[key].toString().trim() : '';
                    
                    // Clean column names (remove extra spaces, etc.)
                    const cleanKey = key.trim();
                    cleanedSite[cleanKey] = value;
                });
                
                // Ensure we have required fields
                if (!cleanedSite["Site ID"] && !cleanedSite["Site Name"]) {
                    console.warn('Skipping row without Site ID or Site Name:', cleanedSite);
                    return;
                }
                
                // Parse coordinates
                let latitude = null;
                let longitude = null;
                
                if (cleanedSite["Y_LATITUDE"]) {
                    const latStr = cleanedSite["Y_LATITUDE"].toString().replace(',', '.');
                    latitude = parseFloat(latStr);
                }
                
                if (cleanedSite["X_LONGITUDE"]) {
                    const lngStr = cleanedSite["X_LONGITUDE"].toString().replace(',', '.');
                    longitude = parseFloat(lngStr);
                }
                
                // Add to regions set for filter
                if (cleanedSite["Region"]) {
                    regions.add(cleanedSite["Region"]);
                }
                
                // Add processed site to data
                const processedSite = {
                    ...cleanedSite,
                    "Y_LATITUDE": latitude,
                    "X_LONGITUDE": longitude,
                    isVIP: cleanedSite["Category VIP POI"] && 
                          (cleanedSite["Category VIP POI"].includes("VIP") || 
                           cleanedSite["Category VIP POI"].includes("Airport") ||
                           cleanedSite["Category VIP POI"].includes("POI")),
                    has5G: cleanedSite["Network Type"] && cleanedSite["Network Type"].includes("5G"),
                    vendorClass: `vendor-${(cleanedSite["Vendor"] || 'unknown').toLowerCase()}`,
                    networkClass: getNetworkClass(cleanedSite["Network Type"])
                };
                
                allSiteData.push(processedSite);
                
                // Update statistics
                const vendor = cleanedSite["Vendor"] || 'Unknown';
                vendorStats[vendor] = (vendorStats[vendor] || 0) + 1;
                
                const netType = cleanedSite["Network Type"] || 'Unknown';
                networkStats[netType] = (networkStats[netType] || 0) + 1;
            });
            
            console.log(`Processed ${allSiteData.length} site records`);
            console.log(`Found ${Object.keys(vendorStats).length} vendors`);
            console.log(`Found ${Object.keys(networkStats).length} network types`);
            
            // Update region filter dropdown
            updateRegionFilter(Array.from(regions));
            
            // Reset filtered data to all data
            filteredSiteData = [...allSiteData];
            
            // Update UI
            updateDashboard();
        }

        function updateRegionFilter(regions) {
            const regionSelect = document.getElementById('filterRegion');
            const currentValue = regionSelect.value;
            
            // Clear existing options except first
            while (regionSelect.options.length > 1) {
                regionSelect.remove(1);
            }
            
            // Sort regions alphabetically
            regions.sort();
            
            // Add new options
            regions.forEach(region => {
                if (region) { // Skip empty regions
                    const option = document.createElement('option');
                    option.value = region;
                    option.textContent = region;
                    regionSelect.appendChild(option);
                }
            });
            
            // Restore previous selection if it still exists
            if (currentValue && Array.from(regionSelect.options).some(opt => opt.value === currentValue)) {
                regionSelect.value = currentValue;
            }
        }

        function getNetworkClass(networkType) {
            if (!networkType) return 'badge-2g';
            if (networkType.includes("5G")) return 'badge-5g';
            if (networkType.includes("4G")) return 'badge-4g';
            if (networkType.includes("2G")) return 'badge-2g';
            return 'badge-2g';
        }

        // ==================== FUNGSI FILTER ====================
        function applyFilters() {
            const searchSiteId = document.getElementById('searchSiteId').value.toLowerCase();
            const searchSiteName = document.getElementById('searchSiteName').value.toLowerCase();
            const filterVendor = document.getElementById('filterVendor').value;
            const filterNetworkType = document.getElementById('filterNetworkType').value;
            const filterRegion = document.getElementById('filterRegion').value;
            
            filteredSiteData = allSiteData.filter(site => {
                // Site ID search
                if (searchSiteId && site["Site ID"] && !site["Site ID"].toLowerCase().includes(searchSiteId)) {
                    return false;
                }
                
                // Site Name search
                if (searchSiteName && site["Site Name"] && !site["Site Name"].toLowerCase().includes(searchSiteName)) {
                    return false;
                }
                
                // Vendor filter
                if (filterVendor && site["Vendor"] !== filterVendor) {
                    return false;
                }
                
                // Network Type filter
                if (filterNetworkType) {
                    const netType = site["Network Type"] || '';
                    if (filterNetworkType === "5G" && !netType.includes("5G")) {
                        return false;
                    }
                    if (filterNetworkType === "4G" && !netType.includes("4G")) {
                        return false;
                    }
                    if (filterNetworkType === "2G" && !netType.includes("2G")) {
                        return false;
                    }
                    if (filterNetworkType === "2G_4G" && !netType.includes("2G_4G")) {
                        return false;
                    }
                    if (filterNetworkType === "2G_4G_5G" && !netType.includes("2G_4G_5G")) {
                        return false;
                    }
                }
                
                // Region filter
                if (filterRegion && site["Region"] !== filterRegion) {
                    return false;
                }
                
                return true;
            });
            
            updateDashboard();
        }

        function filterByVIP() {
            filteredSiteData = allSiteData.filter(site => site.isVIP);
            document.getElementById('filterVendor').value = '';
            document.getElementById('filterNetworkType').value = '';
            document.getElementById('filterRegion').value = '';
            document.getElementById('searchSiteId').value = '';
            document.getElementById('searchSiteName').value = '';
            updateDashboard();
        }

        function clearFilters() {
            document.getElementById('searchSiteId').value = '';
            document.getElementById('searchSiteName').value = '';
            document.getElementById('filterVendor').value = '';
            document.getElementById('filterNetworkType').value = '';
            document.getElementById('filterRegion').value = '';
            filteredSiteData = [...allSiteData];
            updateDashboard();
        }

        // ==================== FUNGSI UPDATE UI ====================
        function updateDashboard() {
            updateKPIs();
            updateDataTable();
            updateMapMarkers();
            updateBreakdownTables();
            updateSiteCount();
        }

        function updateKPIs() {
            const totalSites = filteredSiteData.length;
            const sites5G = filteredSiteData.filter(site => site.has5G).length;
            const vipSites = filteredSiteData.filter(site => site.isVIP).length;
            const uniqueClusters = new Set(filteredSiteData.map(site => site["Micro Cluster"]).filter(Boolean)).size;
            
            document.getElementById('kpiTotalSites').textContent = totalSites.toLocaleString();
            document.getElementById('kpi5GSites').textContent = sites5G.toLocaleString();
            document.getElementById('kpiVipSites').textContent = vipSites.toLocaleString();
            document.getElementById('kpiClusters').textContent = uniqueClusters.toLocaleString();
        }

        function updateDataTable() {
            // Clear existing data
            dataTable.clear();
            
            // Add new data
            filteredSiteData.forEach(site => {
                const vendor = site["Vendor"] || 'Unknown';
                const networkType = site["Network Type"] || 'Unknown';
                const siteType = site["Site Type"] || 'Unknown';
                const region = site["Region"] || 'N/A';
                const microCluster = site["Micro Cluster"] || 'N/A';
                const enodebId = site["Enodeb ID"] || 'N/A';
                const tac = site["TAC"] || 'N/A';
                const vipCategory = site["Category VIP POI"] || 'N/A';
                
                const vendorClass = vendor.toLowerCase();
                const networkClass = getNetworkClass(networkType);
                const siteTypeClass = siteType.includes("VIP") ? "badge-vip" : 
                                    siteType.includes("Micro") ? "badge-micro" : "badge-macro";
                
                const row = [
                    site["Site ID"] || 'N/A',
                    site["Site Name"] || 'N/A',
                    `<span class="badge badge-${vendorClass}">${vendor}</span>`,
                    `<span class="badge ${networkClass}">${networkType}</span>`,
                    `<span class="badge ${siteTypeClass}">${siteType}</span>`,
                    vipCategory,
                    region,
                    microCluster,
                    enodebId,
                    tac
                ];
                
                dataTable.row.add(row);
            });
            
            // Draw the table
            dataTable.draw();
            
            // Add VIP row highlighting
            setTimeout(() => {
                $('#detailedSiteTable tbody tr').each(function(index) {
                    if (filteredSiteData[index] && filteredSiteData[index].isVIP) {
                        $(this).addClass('vip-row');
                    }
                });
            }, 100);
        }

        function updateMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => marker.removeFrom(map));
            markers = [];
            
            // Get vendor filter states
            const showHuawei = document.getElementById('showHuawei').checked;
            const showNokia = document.getElementById('showNokia').checked;
            const showEricsson = document.getElementById('showEricsson').checked;
            const showZTE = document.getElementById('showZTE').checked;
            
            // Count sites with coordinates
            let sitesWithCoords = 0;
            
            // Add markers for filtered sites
            filteredSiteData.forEach(site => {
                // Check if vendor should be shown
                let shouldShow = false;
                const vendor = site["Vendor"] || '';
                switch(vendor.toLowerCase()) {
                    case 'huawei': shouldShow = showHuawei; break;
                    case 'nokia': shouldShow = showNokia; break;
                    case 'ericsson': shouldShow = showEricsson; break;
                    case 'zte': shouldShow = showZTE; break;
                    default: shouldShow = true;
                }
                
                if (!shouldShow) return;
                
                const lat = site["Y_LATITUDE"];
                const lng = site["X_LONGITUDE"];
                
                // Check if coordinates are valid
                if (lat && lng && !isNaN(lat) && !isNaN(lng) && lat !== 0 && lng !== 0) {
                    sitesWithCoords++;
                    
                    // Determine marker color based on vendor
                    let markerColor = 'blue';
                    switch(vendor.toLowerCase()) {
                        case 'huawei': markerColor = 'red'; break;
                        case 'nokia': markerColor = 'blue'; break;
                        case 'ericsson': markerColor = 'darkblue'; break;
                        case 'zte': markerColor = 'green'; break;
                        default: markerColor = 'gray';
                    }
                    
                    // Determine icon based on site type
                    let iconHtml = '';
                    if (site.isVIP) {
                        iconHtml = `<div style="background-color: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid gold; box-shadow: 0 0 5px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;">
                                      <i class="fas fa-crown" style="color: white; font-size: 10px;"></i>
                                   </div>`;
                    } else {
                        iconHtml = `<div style="background-color: ${markerColor}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>`;
                    }
                    
                    // Create custom icon
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: iconHtml,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    const marker = L.marker([lat, lng], { icon: icon })
                        .addTo(map)
                        .bindPopup(`
                            <strong>${site["Site Name"] || site["Site ID"]}</strong><br>
                            <small>${site["Site ID"]}</small><br>
                            Vendor: ${vendor}<br>
                            Network: ${site["Network Type"] || 'N/A'}<br>
                            Type: ${site["Site Type"] || 'N/A'}<br>
                            Cluster: ${site["Micro Cluster"] || 'N/A'}<br>
                            <button class="btn btn-sm btn-primary mt-1" onclick="focusOnSite('${site["Site ID"]}')">
                                View Details
                            </button>
                        `);
                    
                    markers.push(marker);
                }
            });
            
            console.log(`Added ${sitesWithCoords} markers with valid coordinates`);
            
            // Fit map to show all markers if there are any
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            } else {
                // Default to Jakarta if no markers
                map.setView([-6.12, 106.67], 12);
            }
        }

        function focusOnSite(siteId) {
            const site = allSiteData.find(s => s["Site ID"] === siteId);
            if (site && site["Y_LATITUDE"] && site["X_LONGITUDE"]) {
                map.setView([site["Y_LATITUDE"], site["X_LONGITUDE"]], 15);
                
                // Find and open the marker popup
                markers.forEach(marker => {
                    const latLng = marker.getLatLng();
                    if (latLng.lat === site["Y_LATITUDE"] && latLng.lng === site["X_LONGITUDE"]) {
                        marker.openPopup();
                    }
                });
            }
        }

        function updateBreakdownTables() {
            // Vendor breakdown
            const vendorBody = document.getElementById('vendorBreakdownBody');
            const vendorTotal = filteredSiteData.length;
            
            let vendorHTML = '';
            const currentVendorStats = {};
            
            filteredSiteData.forEach(site => {
                const vendor = site["Vendor"] || 'Unknown';
                currentVendorStats[vendor] = (currentVendorStats[vendor] || 0) + 1;
            });
            
            // Sort vendors by count (descending)
            const sortedVendors = Object.entries(currentVendorStats)
                .sort((a, b) => b[1] - a[1]);
            
            sortedVendors.forEach(([vendor, count]) => {
                const percentage = vendorTotal > 0 ? ((count / vendorTotal) * 100).toFixed(1) : '0.0';
                vendorHTML += `
                    <tr>
                        <td class="small"><span class="badge badge-${vendor.toLowerCase()}">${vendor}</span></td>
                        <td class="text-end fw-semibold">${count}</td>
                        <td class="text-end text-muted">${percentage}%</td>
                    </tr>
                `;
            });
            
            vendorBody.innerHTML = vendorHTML || '<tr><td colspan="3" class="text-center py-4">No data</td></tr>';
            
            // Network type breakdown
            const networkBody = document.getElementById('networkBreakdownBody');
            
            let networkHTML = '';
            const currentNetworkStats = {};
            
            filteredSiteData.forEach(site => {
                const netType = site["Network Type"] || 'Unknown';
                currentNetworkStats[netType] = (currentNetworkStats[netType] || 0) + 1;
            });
            
            // Sort network types by count (descending)
            const sortedNetworks = Object.entries(currentNetworkStats)
                .sort((a, b) => b[1] - a[1]);
            
            sortedNetworks.forEach(([netType, count]) => {
                const percentage = vendorTotal > 0 ? ((count / vendorTotal) * 100).toFixed(1) : '0.0';
                const badgeClass = getNetworkClass(netType);
                const displayName = netType.split(' ')[0] || netType;
                networkHTML += `
                    <tr>
                        <td class="small"><span class="badge ${badgeClass}">${displayName}</span></td>
                        <td class="text-end fw-semibold">${count}</td>
                        <td class="text-end text-muted">${percentage}%</td>
                    </tr>
                `;
            });
            
            networkBody.innerHTML = networkHTML || '<tr><td colspan="3" class="text-center py-4">No data</td></tr>';
        }

        function updateSiteCount() {
            const totalSites = allSiteData.length;
            const filteredSites = filteredSiteData.length;
            document.getElementById('siteCount').textContent = filteredSites.toLocaleString();
            
            const resultsText = document.getElementById('searchResultsText');
            
            if (filteredSites < totalSites) {
                resultsText.innerHTML = `Showing <span class="fw-semibold">${filteredSites.toLocaleString()}</span> of <span class="fw-semibold">${totalSites.toLocaleString()}</span> sites`;
                resultsText.className = 'text-success fw-semibold';
            } else {
                resultsText.innerHTML = `Showing all <span class="fw-semibold">${totalSites.toLocaleString()}</span> sites`;
                resultsText.className = 'text-muted';
            }
        }

        // ==================== FUNGSI LOADING & STATUS ====================
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.style.display = 'flex';
            } else {
                overlay.style.display = 'none';
            }
        }

        function updateDashboardStatus(status, message) {
            const statusBadge = document.getElementById('dashboardStatus');
            
            switch(status) {
                case 'loading':
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.innerHTML = `<i class="fas fa-circle me-1"></i> ${message}`;
                    break;
                case 'success':
                    statusBadge.className = 'badge bg-success';
                    statusBadge.innerHTML = `<i class="fas fa-circle me-1"></i> ${message}`;
                    break;
                case 'warning':
                    statusBadge.className = 'badge bg-warning';
                    statusBadge.innerHTML = `<i class="fas fa-circle me-1"></i> ${message}`;
                    break;
                case 'error':
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.innerHTML = `<i class="fas fa-circle me-1"></i> ${message}`;
                    break;
                default:
                    statusBadge.className = 'badge bg-secondary';
                    statusBadge.innerHTML = `<i class="fas fa-circle me-1"></i> ${message}`;
            }
        }

        function updateDataSourceInfo(message) {
            document.getElementById('dataSourceInfo').textContent = message;
        }

        // ==================== FUNGSI WAKTU & AUTO-REFRESH ====================
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit'
            });
            document.getElementById('lastUpdatedTime').textContent = timeString;
        }

        function resetAutoRefreshCountdown() {
            refreshCountdown = 30;
        }

        function toggleAutoRefresh() {
            const toggle = document.getElementById('autoRefreshToggle');
            
            if (toggle.checked) {
                // Start auto-refresh interval
                if (autoRefreshInterval) clearInterval(autoRefreshInterval);
                
                autoRefreshInterval = setInterval(() => {
                    refreshCountdown--;
                    
                    if (refreshCountdown <= 0) {
                        fetchCSVData();
                    }
                }, 1000);
                
                console.log('Auto-refresh enabled (30 seconds)');
            } else {
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                console.log('Auto-refresh disabled');
            }
        }

        // ==================== FUNGSI EKSPOR ====================
        function exportToCSV() {
            if (filteredSiteData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            // Get headers from first object (excluding processed fields)
            const firstSite = filteredSiteData[0];
            const headers = Object.keys(firstSite).filter(key => 
                !['isVIP', 'has5G', 'vendorClass', 'networkClass'].includes(key)
            );
            
            // Prepare CSV content
            const csvRows = [
                headers.join(','),
                ...filteredSiteData.map(site => {
                    return headers.map(header => {
                        const value = site[header] || '';
                        // Escape quotes and wrap in quotes if contains comma
                        const escaped = value.toString().replace(/"/g, '""');
                        return escaped.includes(',') ? `"${escaped}"` : escaped;
                    }).join(',');
                })
            ];
            
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `site_info_export_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // ==================== FUNGSI BANTUAN ====================
        function showSampleData() {
            processSiteData(SAMPLE_DATA);
            updateDashboardStatus('info', 'Showing sample data');
            updateDataSourceInfo('Showing sample data');
            alert('Now showing sample data. Click "Refresh Data" to load from CSV again.');
        }

        window.debugData = function() {
            console.log('All Site Data:', allSiteData);
            console.log('Filtered Site Data:', filteredSiteData);
            console.log('Vendor Stats:', vendorStats);
            console.log('Network Stats:', networkStats);
            alert(`Data logged to console. Total sites: ${allSiteData.length}`);
        };

        // Ekspos fungsi penting untuk debugging
        window.fetchCSVData = fetchCSVData;
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.exportToCSV = exportToCSV;
        window.focusOnSite = focusOnSite;
        window.showSampleData = showSampleData;
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
