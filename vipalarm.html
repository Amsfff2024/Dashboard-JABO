<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>VIP Alarms Dashboard</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body{
  margin:0;
  background:#f4f6f9;
  font-family:Segoe UI, Roboto;
}
.header-bar{
  background:linear-gradient(135deg,#1e3c72,#2a7db8);
  color:#fff;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.card-summary{
  border-radius:12px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}
.badge-aging{
  font-size:13px;
  padding:6px 10px;
  border-radius:20px;
}
.table thead th{
  cursor:pointer;
  background:#2c3e50;
  color:#fff;
  font-size:13px;
}
.table tbody td{
  font-size:13px;
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header-bar">
  <h5 class="m-0">VIP Alarms Dashboard</h5>
  <div>
    <span id="lastUpdate">-</span>
    <button class="btn btn-sm btn-light ms-2" onclick="loadData()">Refresh</button>
  </div>
</div>

<div class="container-fluid p-3">

<!-- SUMMARY ROW -->
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card card-summary p-3">
      <div>Total Alarms</div>
      <h3 id="totalAlarm">0</h3>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card card-summary p-3">
      <div>Unique Site ID</div>
      <h3 id="uniqueSite">0</h3>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card card-summary p-3">
      <div>&le; 1 Day</div>
      <h4 id="aging1">0</h4>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card card-summary p-3">
      <div>&le; 3 Days</div>
      <h4 id="aging3">0</h4>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card card-summary p-3">
      <div>&ge; 4 Days</div>
      <h4 id="aging4">0</h4>
    </div>
  </div>
</div>

<!-- FILTER -->
<div class="card p-3 mb-3">
  <div class="row g-2">
    <div class="col-md-3">
      <input id="fAlarm" class="form-control" placeholder="Alarm Name">
    </div>
    <div class="col-md-2">
      <input id="fSite" class="form-control" placeholder="Site ID">
    </div>
    <div class="col-md-3">
      <input id="fCategory" class="form-control" placeholder="Category VIP POI">
    </div>
    <div class="col-md-2">
      <input id="fSource" class="form-control" placeholder="Source">
    </div>
    <div class="col-md-2 d-flex gap-2">
      <button class="btn btn-primary w-100" onclick="applyFilter()">Filter</button>
      <button class="btn btn-secondary w-100" onclick="clearFilter()">Clear</button>
    </div>
  </div>
</div>

<!-- EXPORT -->
<div class="text-end mb-2">
  <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
</div>

<!-- TABLE -->
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
  <th onclick="sortTable('SITE ID')">Site ID</th>
  <th onclick="sortTable('Alarm Source')">Site Name</th>
  <th onclick="sortTable('Name')">Alarm Name</th>
  <th onclick="sortTable('Site Type')">Site Type</th>
  <th onclick="sortTable('Category VIP POI')">Category</th>
   <th onclick="sortTable('Source')">OSS</th>
  <th onclick="sortTable('First Occurred (NT)')">First Occurred</th>
  <th onclick="sortTable('MO Name')">MO Name</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>

</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReYyDGCMuGVv6quqOtRns55K-nHRF9Jc_9qmN9tNHACirvFr7YLPN3ZR3voorWD0opy7f1GflJ9eEC/pub?gid=434029938&single=true&output=csv";

let rawData = [];
let filteredData = [];
let sortDir = 1;

function loadData(){
  Papa.parse(CSV_URL,{
    download:true,
    header:true,
    skipEmptyLines:true,
    complete: res => {
      rawData = res.data;
      filteredData = [...rawData];
      render();
      document.getElementById("lastUpdate").innerText =
        "Last Update: " + new Date().toLocaleString();
    }
  });
}

function render(){
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  filteredData.forEach(r=>{
    const ossValue = r["Source"] || r["Alarm Source"] || "";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r["SITE ID"]||""}</td>
      <td>${r["Alarm Source"]||""}</td>
      <td>${r["Name"]||""}</td>
      <td>${r["Site Type"]||""}</td>
      <td>${r["Category VIP POI"]||""}</td>

      <!-- âœ… NEW -->
      <td>${ossValue}</td>

      <td>${r["First Occurred (NT)"]||""}</td>
      <td>${r["MO Name"]||""}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("totalAlarm").innerText = filteredData.length;
  document.getElementById("uniqueSite").innerText =
    new Set(filteredData.map(d=>d["SITE ID"])).size;

  calculateAging();
}


function calculateAging(){
  let d1=0,d3=0,d4=0;
  const now = new Date();

  filteredData.forEach(r=>{
    const dt = new Date(r["First Occurred (NT)"]);
    const days = (now - dt)/(1000*3600*24);
    if(days<=1) d1++;
    else if(days<=3) d3++;
    else d4++;
  });

  document.getElementById("aging1").innerText = d1;
  document.getElementById("aging3").innerText = d3;
  document.getElementById("aging4").innerText = d4;
}

function applyFilter(){
  const a = fAlarm.value.toLowerCase();
  const s = fSite.value.toLowerCase();
  const c = fCategory.value.toLowerCase();
  const src = fSource.value.toLowerCase();

  filteredData = rawData.filter(r => {
    const ossValue = (r["Source"] || r["Alarm Source"] || "").toLowerCase();

    return (
      (!a || (r["Name"]||"").toLowerCase().includes(a)) &&
      (!s || (r["SITE ID"]||"").toLowerCase().includes(s)) &&
      (!c || (r["Category VIP POI"]||"").toLowerCase().includes(c)) &&
      (!src || ossValue.includes(src))
    );
  });

  render();
}


function clearFilter(){
  fAlarm.value="";
  fSite.value="";
  fCategory.value="";
  fSource.value="";
  filteredData = [...rawData];
  render();
}

function sortTable(col){
  sortDir *= -1;
  filteredData.sort((a,b)=>
    (a[col]||"").localeCompare(b[col]||"") * sortDir
  );
  render();
}

function exportCSV(){
  const csv = Papa.unparse(filteredData);
  const blob = new Blob([csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "vip_alarm_export.csv";
  a.click();
}

loadData();
</script>

</body>
</html>
